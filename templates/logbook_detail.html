{% extends "base.html" %}

{% block title %}{{ plant.plant_name }} - Logbook | Sophie's Garden{% endblock %}

{% block content %}
<section class="space-y-6">
  <div class="breadcrumbs text-sm"><ul><li><a href="{{ url_for('logbook') }}">Logbook</a></li><li>{{ plant.plant_name }}</li></ul></div>

  <!-- Header -->
  <div class="card garden-glass">
    <div class="card-body grid grid-cols-1 lg:grid-cols-[1fr_320px] gap-8">
      <div>
        <div class="flex items-start gap-4">
          <div class="w-28 h-28 rounded-xl overflow-hidden bg-base-200 flex items-center justify-center text-4xl">
            {% if plant.image_url %}
              <img src="{{ plant.image_url }}" alt="{{ plant.plant_name }}" class="w-28 h-28 object-cover">
            {% else %}
              ðŸŒ±
            {% endif %}
          </div>
          <div class="flex-1">
            <h1 class="font-display text-3xl font-bold gradient-text">
              {{ plant.plant_name }}{% if plant.variety %} â€” <span class="opacity-80 text-base font-normal">{{ plant.variety }}</span>{% endif %}
              {% if plant.nickname %}<span class="badge badge-outline ml-2">{{ plant.nickname }}</span>{% endif %}
            </h1>
            <div class="text-sm opacity-80 mt-1">
              {{ plant.category|capitalize }}{% if plant.location %} â€¢ {{ plant.location }}{% endif %}
              {% if plant.scientific_name %} â€¢ <em>{{ plant.scientific_name }}</em>{% endif %}
            </div>
            <div class="text-sm opacity-70 mt-1">
              {% if plant.planting_date %}Planted {{ plant.planting_date.strftime('%b %d, %Y') }}{% endif %}
            </div>
          </div>
          <div>
            <span class="badge {% if plant.status=='active' %}badge-success{% elif plant.status=='harvested' %}badge-info{% else %}badge-ghost{% endif %}">{{ plant.status|capitalize }}</span>
          </div>
        </div>

        <div class="mt-4 text-sm opacity-90">{{ plant.notes }}</div>
      </div>

      <aside>
        <div class="card garden-glass">
          <div class="card-body">
            <h3 class="font-semibold text-primary">Quick Stats</h3>
            <div class="mt-2 grid grid-cols-3 gap-3 text-center">
              <div>
                <div class="text-2xl font-bold">{{ observations|length }}</div>
                <div class="text-xs opacity-70">Observations</div>
              </div>
              <div>
                <div class="text-2xl font-bold">{{ care|length }}</div>
                <div class="text-xs opacity-70">Care</div>
              </div>
              <div>
                <div class="text-2xl font-bold">{{ harvests|length }}</div>
                <div class="text-xs opacity-70">Harvests</div>
              </div>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Insights & Quick Actions -->
  <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 space-y-6">
      <div class="card garden-glass">
        <div class="card-body">
          <h2 class="card-title text-primary">Care schedule & insights</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
            <div>
              <div class="opacity-70">Last water</div>
              <div class="font-medium">{{ insights.last_water.strftime('%b %d, %Y') if insights.last_water else 'â€”' }}</div>
            </div>
            <div>
              <div class="opacity-70">Next water</div>
              <div class="font-medium">{{ insights.next_water.strftime('%b %d, %Y') if insights.next_water else 'â€”' }}</div>
            </div>
            <div>
              <div class="opacity-70">Interval</div>
              <div class="font-medium">{{ insights.water_interval_days }} days</div>
            </div>
            <div>
              <div class="opacity-70">Last fertilize</div>
              <div class="font-medium">{{ insights.last_fert.strftime('%b %d, %Y') if insights.last_fert else 'â€”' }}</div>
            </div>
            <div>
              <div class="opacity-70">Next fertilize</div>
              <div class="font-medium">{{ insights.next_fert.strftime('%b %d, %Y') if insights.next_fert else 'â€”' }}</div>
            </div>
            <div>
              <div class="opacity-70">Fert. interval</div>
              <div class="font-medium">{{ insights.fert_interval_days }} days</div>
            </div>
            <div>
              <div class="opacity-70">Days since planting</div>
              <div class="font-medium">{{ insights.days_since_planting if insights.days_since_planting is not none else 'â€”' }}</div>
            </div>
            <div>
              <div class="opacity-70">First flower</div>
              <div class="font-medium">{{ insights.first_flower.strftime('%b %d, %Y') if insights.first_flower else 'â€”' }}</div>
            </div>
            <div>
              <div class="opacity-70">First fruit</div>
              <div class="font-medium">{{ insights.first_fruit.strftime('%b %d, %Y') if insights.first_fruit else 'â€”' }}</div>
            </div>
          </div>
          {% if harvest_totals %}
          <div class="divider"></div>
          <div class="text-sm">
            <div class="opacity-70 mb-1">Harvest totals</div>
            <div class="flex flex-wrap gap-2">
              {% for unit, qty in harvest_totals.items() %}
                <span class="badge badge-outline">{{ qty }} {{ unit }}</span>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Growth chart -->
      <div class="card garden-glass">
        <div class="card-body">
          <h2 class="card-title text-primary">Growth</h2>
          {% if series and series|length > 1 %}
            <canvas id="growthChart" height="200"></canvas>
          {% else %}
            <div class="opacity-80 text-sm">Add height observations to see growth over time.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="space-y-6">
      <!-- Suggestions -->
      <div class="card garden-glass">
        <div class="card-body">
          <h3 class="card-title text-primary">Suggestions</h3>
          {% if suggestions %}
            <ul class="menu menu-sm">
              {% for s in suggestions %}
                <li><span class="{{ 'text-error' if s.severity=='high' else ('text-warning' if s.severity=='medium' else 'text-info') }}">â€¢ {{ s.title }}</span></li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="opacity-70 text-sm">No suggestions right now.</div>
          {% endif %}
        </div>
      </div>

      <!-- Quick actions -->
      <div class="card garden-glass">
        <div class="card-body">
          <h3 class="card-title text-primary">Quick actions</h3>
          <form method="post" action="{{ url_for('quick_water', plant_id=plant.id) }}" class="flex gap-2 items-end">
            <div class="form-control">
              <label class="label"><span class="label-text">Water amount</span></label>
              <input name="amount" class="input input-bordered" placeholder="500ml">
            </div>
            <button class="btn btn-sm">Water now</button>
          </form>
          <form method="post" action="{{ url_for('quick_fertilize', plant_id=plant.id) }}" class="flex gap-2 items-end mt-3">
            <div class="form-control">
              <label class="label"><span class="label-text">Fertilizer</span></label>
              <input name="amount" class="input input-bordered" placeholder="NPK 10-10-10 5g">
            </div>
            <button class="btn btn-sm">Fertilize</button>
          </form>
          <div class="mt-4">
            <a class="btn btn-ghost btn-sm" href="{{ url_for('export_log_csv', plant_id=plant.id) }}">Export CSV</a>
          </div>
        </div>
      </div>

      <!-- Companions -->
      {% if companions %}
      <div class="card garden-glass">
        <div class="card-body">
          <h3 class="card-title text-primary">Companion planting</h3>
          <div class="text-sm"><span class="opacity-70">Good:</span> {{ companions.good | join(', ') }}</div>
          <div class="text-sm"><span class="opacity-70">Avoid:</span> {{ companions.avoid | join(', ') }}</div>
        </div>
      </div>
      {% endif %}
    </div>
  </section>

  <!-- Add entries -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Observation form -->
    <form method="post" action="{{ url_for('add_observation', plant_id=plant.id) }}" class="card garden-glass">
      <div class="card-body">
        <h3 class="card-title text-primary">Add Observation</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="form-control">
            <label class="label"><span class="label-text">Date</span></label>
            <input type="date" name="date" class="input input-bordered" value="{{ ("%Y-%m-%d"|strftime) if false else '' }}">
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">Height (cm)</span></label>
            <input type="number" step="0.1" name="height_cm" class="input input-bordered">
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">Leaves</span></label>
            <input type="number" name="leaves" class="input input-bordered">
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">Flowers</span></label>
            <input type="number" name="flowers" class="input input-bordered">
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">Fruits</span></label>
            <input type="number" name="fruits" class="input input-bordered">
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">Photo URL</span></label>
            <input type="url" name="photo_url" class="input input-bordered" placeholder="https://...">
          </div>
          <div class="form-control md:col-span-2">
            <label class="label"><span class="label-text">Pests</span></label>
            <input type="text" name="pests" class="input input-bordered" placeholder="aphids, mites...">
          </div>
          <div class="form-control md:col-span-2">
            <label class="label"><span class="label-text">Diseases</span></label>
            <input type="text" name="diseases" class="input input-bordered" placeholder="powdery mildew...">
          </div>
          <div class="form-control md:col-span-2">
            <label class="label"><span class="label-text">Notes</span></label>
            <textarea name="notes" class="textarea textarea-bordered" rows="3" placeholder="Observation notes..."></textarea>
          </div>
        </div>
        <div class="card-actions justify-end">
          <button class="btn btn-primary btn-sm">Add Observation</button>
        </div>
      </div>
    </form>

    <!-- Care form -->
    <form method="post" action="{{ url_for('add_care', plant_id=plant.id) }}" class="card garden-glass">
      <div class="card-body">
        <h3 class="card-title text-primary">Log Care</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="form-control">
            <label class="label"><span class="label-text">Date</span></label>
            <input type="date" name="date" class="input input-bordered">
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">Type</span></label>
            <select name="type" class="select select-bordered" required>
              <option value="">Choose</option>
              <option>watering</option>
              <option>fertilizing</option>
              <option>pruning</option>
              <option>weeding</option>
              <option>transplanting</option>
              <option>spray</option>
              <option>other</option>
            </select>
          </div>
          <div class="form-control md:col-span-2">
            <label class="label"><span class="label-text">Amount / Details</span></label>
            <input type="text" name="amount" class="input input-bordered" placeholder="500ml, NPK 10-10-10 5g, light prune...">
          </div>
          <div class="form-control md:col-span-2">
            <label class="label"><span class="label-text">Notes</span></label>
            <textarea name="notes" class="textarea textarea-bordered" rows="3" placeholder="Care notes..."></textarea>
          </div>
        </div>
        <div class="card-actions justify-end">
          <button class="btn btn-primary btn-sm">Add Care</button>
        </div>
      </div>
    </form>

    <!-- Harvest form -->
    <form method="post" action="{{ url_for('add_harvest', plant_id=plant.id) }}" class="card garden-glass">
      <div class="card-body">
        <h3 class="card-title text-primary">Record Harvest</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="form-control">
            <label class="label"><span class="label-text">Date</span></label>
            <input type="date" name="date" class="input input-bordered">
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">Quantity</span></label>
            <input type="number" step="0.01" name="quantity" class="input input-bordered" required>
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">Unit</span></label>
            <select name="unit" class="select select-bordered" required>
              <option>g</option>
              <option>kg</option>
              <option>count</option>
              <option>lbs</option>
            </select>
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">Quality</span></label>
            <input type="text" name="quality" class="input input-bordered" placeholder="A, B, ripe, underripe...">
          </div>
          <div class="form-control md:col-span-2">
            <label class="label"><span class="label-text">Photo URL</span></label>
            <input type="url" name="photo_url" class="input input-bordered" placeholder="https://...">
          </div>
          <div class="form-control md:col-span-2">
            <label class="label"><span class="label-text">Notes</span></label>
            <textarea name="notes" class="textarea textarea-bordered" rows="3" placeholder="Harvest notes..."></textarea>
          </div>
        </div>
        <div class="card-actions justify-end">
          <button class="btn btn-primary btn-sm">Add Harvest</button>
        </div>
      </div>
    </form>
  </div>

  <!-- Timeline -->
  <section>
    <h2 class="font-display text-2xl md:text-3xl font-bold gradient-text mb-4">Activity</h2>
    <div class="space-y-4">
      {% for it in timeline %}
        <div class="card garden-glass">
          <div class="card-body">
            {% if it.kind == 'obs' %}
              <div class="text-sm opacity-70">Observation â€¢ {{ it.date.strftime('%b %d, %Y') }}</div>
              {% set o = it.obj %}
              <div class="mt-1 text-sm">
                {% if o.height_cm %}Height: {{ o.height_cm }}cm â€¢ {% endif %}
                {% if o.leaves is not none %}Leaves: {{ o.leaves }} â€¢ {% endif %}
                {% if o.flowers is not none %}Flowers: {{ o.flowers }} â€¢ {% endif %}
                {% if o.fruits is not none %}Fruits: {{ o.fruits }} â€¢ {% endif %}
                {% if o.pests %}Pests: {{ o.pests }} â€¢ {% endif %}
                {% if o.diseases %}Diseases: {{ o.diseases }} â€¢ {% endif %}
                {% if o.photo_url %}<a href="{{ o.photo_url }}" target="_blank" class="link">Photo</a>{% endif %}
              </div>
              {% if o.notes %}<div class="mt-2">{{ o.notes }}</div>{% endif %}
            {% elif it.kind == 'care' %}
              {% set c = it.obj %}
              <div class="text-sm opacity-70">Care: {{ c.type|capitalize }} â€¢ {{ c.date.strftime('%b %d, %Y') }}</div>
              <div class="mt-1 text-sm">{{ c.amount }}</div>
              {% if c.notes %}<div class="mt-2">{{ c.notes }}</div>{% endif %}
            {% elif it.kind == 'harvest' %}
              {% set h = it.obj %}
              <div class="text-sm opacity-70">Harvest â€¢ {{ h.date.strftime('%b %d, %Y') }}</div>
              <div class="mt-1 text-sm">
                {{ h.quantity }} {{ h.unit }}{% if h.quality %} â€¢ {{ h.quality }}{% endif %}
                {% if h.photo_url %} â€¢ <a href="{{ h.photo_url }}" target="_blank" class="link">Photo</a>{% endif %}
              </div>
              {% if h.notes %}<div class="mt-2">{{ h.notes }}</div>{% endif %}
            {% endif %}
          </div>
        </div>
      {% endfor %}

      {% if not timeline %}
        <div class="card garden-glass"><div class="card-body opacity-80">No activity yet. Add an observation, care, or harvest above.</div></div>
      {% endif %}
    </div>
  </section>
</section>
{% endblock %}

{% block extra_head %}
  {{ super() }}
  <script id="growth-data" type="application/json">{{ (series or []) | tojson }}</script>
  <script>
  document.addEventListener('DOMContentLoaded', function(){
    const raw = (document.getElementById('growth-data')?.textContent || '[]');
    let series = [];
    try { series = JSON.parse(raw); } catch (e) { series = []; }
    if(!series || series.length < 2) return;
    const canvas = document.getElementById('growthChart');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = canvas.width = canvas.clientWidth;
    const H = canvas.height = Number(canvas.getAttribute('height')) || canvas.clientHeight || 200;
    const xs = series.map(p => new Date(p.d).getTime());
    const ys = series.map(p => Number(p.h));
    const minX = Math.min(...xs), maxX = Math.max(...xs);
    const minY = Math.min(...ys), maxY = Math.max(...ys);
    const pad = 20;
    function xMap(t){return pad + (W-2*pad) * ((t-minX)/((maxX-minX)||1));}
    function yMap(v){return H-pad - (H-2*pad) * ((v-minY)/((maxY-minY)||1));}
    ctx.clearRect(0,0,W,H);
    // grid
    ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1; ctx.setLineDash([4,4]);
    for(let i=0;i<5;i++){ const y = pad+i*(H-2*pad)/4; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke(); }
    ctx.setLineDash([]);
    // line
    ctx.strokeStyle = '#22c55e'; ctx.lineWidth = 2; ctx.beginPath();
    ctx.moveTo(xMap(xs[0]), yMap(ys[0]));
    for(let i=1;i<xs.length;i++){ ctx.lineTo(xMap(xs[i]), yMap(ys[i])); }
    ctx.stroke();
    // points
    ctx.fillStyle = '#16a34a';
    for(let i=0;i<xs.length;i++){ ctx.beginPath(); ctx.arc(xMap(xs[i]), yMap(ys[i]), 2.5, 0, Math.PI*2); ctx.fill(); }
  });
  </script>
{% endblock %}
