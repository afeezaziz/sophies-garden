{% extends "base.html" %}

{% block title %}{{ post.title }} - Sophie's Garden{% endblock %}

{% block extra_head %}
<meta name="description" content="{{ (post.excerpt or (post.content or '')[:160]) | replace('\n', ' ') }}">
<meta property="og:title" content="{{ post.title }}">
<meta property="og:description" content="{{ (post.excerpt or (post.content or '')[:160]) | replace('\n', ' ') }}">
{% if post.cover_image_url %}
<meta property="og:image" content="{{ post.cover_image_url }}">
{% endif %}
<meta property="og:type" content="article">
{% endblock %}

{% block content %}
  <article class="space-y-8">
    <!-- Hero -->
    {% if post.cover_image_url %}
    <section class="post-hero rounded-2xl overflow-hidden" style="background-image: url('{{ post.cover_image_url }}')">
      <div class="relative z-10 max-w-3xl mx-auto text-center p-10 md:p-14 text-base-100">
        <div class="flex flex-wrap gap-2 justify-center mb-4">
          {% for tag in (post.tags or '').split(',') if tag.strip() %}
            <span class="badge badge-outline">{{ tag.strip() }}</span>
          {% endfor %}
        </div>
        <h1 class="font-display text-4xl md:text-5xl font-bold mb-4">{{ post.title }}</h1>
        <div class="text-sm opacity-90 flex items-center justify-center gap-2">
          {% if post.author %}<span>By {{ post.author }}</span>{% endif %}
          <span>â€¢</span>
          <span>{{ post.published_at.strftime('%b %d, %Y') if post.published_at else '' }}</span>
          <span>â€¢</span>
          <span>{{ read_minutes }} min read</span>
        </div>
      </div>
    </section>
    {% else %}
    <section class="hero-garden rounded-2xl overflow-hidden">
      <div class="max-w-3xl mx-auto text-center p-10 md:p-14">
        <div class="flex flex-wrap gap-2 justify-center mb-4">
          {% for tag in (post.tags or '').split(',') if tag.strip() %}
            <span class="badge badge-outline">{{ tag.strip() }}</span>
          {% endfor %}
        </div>
        <h1 class="font-display text-4xl md:text-5xl font-bold gradient-text mb-4">{{ post.title }}</h1>
        <div class="text-sm opacity-80 flex items-center justify-center gap-2">
          {% if post.author %}<span>By {{ post.author }}</span>{% endif %}
          <span>â€¢</span>
          <span>{{ post.published_at.strftime('%b %d, %Y') if post.published_at else '' }}</span>
          <span>â€¢</span>
          <span>{{ read_minutes }} min read</span>
        </div>
      </div>
    </section>
    {% endif %}

    <!-- Content -->
    <div class="card garden-glass">
      <div class="card-body">
        <div class="grid grid-cols-1 lg:grid-cols-[1fr_280px] gap-8">
          <div>
            <div class="article">
              {{ (post.content or '') | safe }}
            </div>

            <!-- Share -->
            <div class="mt-8 flex flex-col sm:flex-row items-center gap-3 justify-between">
              <div class="text-sm opacity-70">Enjoyed this post? Share it:</div>
              <div class="flex gap-2">
                <a class="btn btn-outline btn-sm" target="_blank" rel="noopener" href="{{ share_twitter }}">Share on X</a>
                <a class="btn btn-outline btn-sm" target="_blank" rel="noopener" href="{{ share_facebook }}">Facebook</a>
                <button class="btn btn-primary btn-sm" onclick="navigator.clipboard.writeText(window.location.href)">Copy Link</button>
              </div>
            </div>
          </div>
          <aside class="hidden lg:block">
            <div class="card garden-glass">
              <div class="card-body sticky top-24">
                <h3 class="font-semibold text-primary mb-2">On this page</h3>
                <ul id="toc" class="menu menu-sm"></ul>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const article = document.querySelector('.article');
        const toc = document.getElementById('toc');
        if(!article || !toc) return;
        const headings = article.querySelectorAll('h1, h2, h3');
        headings.forEach(h => {
          const text = (h.textContent || '').trim();
          if(!text) return;
          const id = text.toLowerCase()
            .replace(/[^a-z0-9\s-]/g,'')
            .replace(/\s+/g,'-');
          if(!h.id) h.id = id;
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = '#' + id;
          a.textContent = text;
          a.className = h.tagName === 'H1' ? 'pl-0' : (h.tagName === 'H2' ? 'pl-2' : 'pl-4 text-sm opacity-80');
          li.appendChild(a);
          toc.appendChild(li);
        });
      })();
    </script>

    <!-- Prev / Next -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card garden-glass hover-lift">
        <div class="card-body">
          {% if prev_post %}
            <div class="text-xs opacity-70">Previous</div>
            <a href="{{ url_for('blog_detail', post_id=prev_post.id) }}" class="card-title text-primary">{{ prev_post.title }}</a>
          {% else %}
            <div class="opacity-60">No previous post</div>
          {% endif %}
        </div>
      </div>
      <div class="card garden-glass hover-lift">
        <div class="card-body text-right">
          {% if next_post %}
            <div class="text-xs opacity-70">Next</div>
            <a href="{{ url_for('blog_detail', post_id=next_post.id) }}" class="card-title text-primary">{{ next_post.title }}</a>
          {% else %}
            <div class="opacity-60">No newer post</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Related posts -->
    {% if related %}
    <section>
      <h2 class="font-display text-2xl md:text-3xl font-bold gradient-text mb-4">Related Posts</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for r in related %}
          <article class="card garden-glass hover-lift">
            <figure class="h-40 overflow-hidden">
              {% if r.cover_image_url %}
                <img src="{{ r.cover_image_url }}" alt="{{ r.title }}" class="w-full h-40 object-cover">
              {% else %}
                <div class="h-40 w-full bg-gradient-to-br from-green-200 to-blue-300 flex items-center justify-center text-4xl">ðŸŒ¿</div>
              {% endif %}
            </figure>
            <div class="card-body">
              <h3 class="card-title text-primary">{{ r.title }}</h3>
              <p class="text-sm opacity-80 line-clamp-2">{{ r.excerpt or (r.content or '')[:120] }}</p>
              <div class="card-actions justify-end">
                <a href="{{ url_for('blog_detail', post_id=r.id) }}" class="btn btn-primary btn-sm">Read</a>
              </div>
            </div>
          </article>
        {% endfor %}
      </div>
    </section>
    {% endif %}
  </article>
{% endblock %}
